<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pembayaran Tagihan - Wifiku</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- SweetAlert2 for notifications -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        /* CSS Tata Letak Utama */
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background: #f8fafc; /* slate-50 */
        }

        #app-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 999;
            background: #f8fafc; /* slate-50 */
        }

        .preview-container {
            position: absolute; 
            top: 0;
            left: 0;
            right: 0;
            bottom: 0; /* Disesuaikan karena navigasi bawah dihapus */
            overflow: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Styles untuk Navigasi (Dihapus, tapi style lain bisa tetap ada) */
         .hidden { display: none; }

        /* Tambahan CSS Loading Screen (untuk konsistensi) */
        #loading-screen {
             z-index: 10000;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Efek Flash Overlay - Dimasukkan tepat setelah Body dibuka -->
    <div id="flash-overlay" class="hidden"></div>

    <!-- Pembungkus Aplikasi Utama -->
    <div id="app-wrapper">
        <div class="preview-container">
            <div class="container mx-auto max-w-lg bg-white min-h-full shadow-lg">
                
                <!-- Loading Screen (Tetap di atas, namun disematkan dalam wrapper) -->
                <div id="loading-screen" class="fixed inset-0 bg-white z-50 flex flex-col justify-center items-center">
                    <div class="w-16 h-16 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin"></div>
                    <p class="mt-4 text-gray-600">Memeriksa sesi login...</p>
                    <p id="debug-info" class="text-xs text-gray-400 mt-2 text-center px-4">Menunggu autentikasi...</p>
                </div>
                
                <!-- Kontainer Utama Aplikasi (Form Pembayaran) -->
                <main id="main-content" class="px-4 pt-6 pb-12 space-y-4 hidden">
                    
                    <!-- Rincian Tagihan -->
                    <div class="bg-white p-6 rounded-lg shadow-sm mb-6 border border-slate-100">
                        <h3 class="text-xl font-semibold mb-4 border-b pb-3 text-slate-800">Rincian Tagihan</h3>
                        <p class="text-slate-500 mt-1">Selesaikan pembayaran tagihan bulan ini.</p>
                        <div id="rincian-tagihan" class="space-y-3 text-sm pt-4">
                            <!-- Data akan diisi oleh JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Metode Pembayaran & Upload Bukti -->
                    <form id="payment-form" class="bg-white p-6 rounded-lg shadow-sm border border-slate-100">
                        <h2 class="text-xl font-semibold mb-4 border-b pb-3">Pilih Metode Pembayaran</h2>
                        
                        <div class="mb-4">
                            <label for="payment-method" class="block text-sm font-medium text-gray-700 mb-2">Metode Pembayaran</label>
                            <select id="payment-method" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500">
                                <option value="">-- Pilih Metode --</option>
                                <option value="BCA">Bank BCA</option>
                                <option value="BRI">Bank BRI</option>
                                <option value="DANA">DANA</option>
                                <option value="OVO">OVO</option>
                                <option value="Qris">QRIS</option>
                            </select>
                        </div>

                        <!-- Detail Pembayaran Dinamis -->
                        <div id="payment-details-container" class="hidden p-4 bg-cyan-50 border-l-4 border-cyan-500 rounded-r-lg mb-6">
                            <!-- Detail akan diisi oleh JavaScript -->
                        </div>
                        
                         <h2 class="text-xl font-semibold mb-4 border-b pb-3 mt-6">Upload Bukti Pembayaran</h2>
                        
                         <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">File Bukti Transfer</label>
                            <label for="payment-proof" class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer hover:border-cyan-400 transition-colors">
                                <div class="space-y-1 text-center">
                                    <svg id="upload-icon" class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                                    </svg>
                                    <div id="image-preview-container" class="hidden w-full max-w-xs mx-auto mb-2">
                                       <img id="image-preview" src="#" alt="Preview Bukti Bayar" class="rounded-lg shadow-md max-h-48 mx-auto object-contain">
                                    </div>
                                    <div class="text-sm text-gray-600">
                                        <span class="font-medium text-cyan-600">Upload file Anda</span>
                                        <span> atau tarik dan lepas</span>
                                    </div>
                                    <p id="upload-text" class="text-xs text-gray-500">PNG, JPG hingga 10MB</p>
                                </div>
                            </label>
                            <input id="payment-proof" name="payment-proof" type="file" class="sr-only" accept="image/jpeg, image/png" required>
                        </div>

                        <button type="submit" id="confirm-payment-btn" class="w-full bg-cyan-500 text-white font-bold py-3 rounded-xl hover:bg-cyan-600 transition-colors flex items-center justify-center gap-2">
                            <i class="fas fa-check-circle"></i>
                            <span>Konfirmasi Pembayaran</span>
                        </button>
                    </form>
                </main>

            </div>
        </div>
    </div>

    <!-- Menggunakan type="module" dan modular imports -->
    <script type="module">
        // --- Modular Firebase Imports (v10.12.2) ---
        // PENTING: Menggunakan impor modular untuk mencegah error 404 pada CDN.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"; 
        // Realtime Database diimpor. Menambahkan 'get' untuk pengambilan data satu kali yang lebih andal.
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js"; 

        // --- Variabel Lingkungan Canvas & Kredensial Pihak Ketiga (Telegram) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // KONFIGURASI FIREBASE HARDCODED
        const firebaseConfig = {
            apiKey: "AIzaSyC2pNYwwn0ildQ4MPlZJv1R6RaEOnKJ4Js",
            authDomain: "baraya-net.firebaseapp.com",
            databaseURL: "https://baraya-net-default-rtdb.firebaseio.com",
            projectId: "baraya-net",
            storageBucket: "baraya-net.firebasestorage.app",
            messagingSenderId: "512354998677",
            appId: "1:512354998677:web:9a91654572c97a958a7e9c"
        };
        
        const TELEGRAM_BOT_TOKEN = "7773318407:AAGbxlu4MmPpUlBbUjJavO_pRCFdPO29Qsw";
        const TELEGRAM_CHAT_ID = "1286256542";
        
        // --- Inisialisasi Firebase ---
        let app, auth, db, rtdb;
        let userId = null;
        let currentCustomer = null;
        
        const paymentInfo = {
            'BCA': { type: 'Bank Transfer', name: 'PT. Wi-Fi Anda Corp.', number: '1234567890' },
            'BRI': { type: 'Bank Transfer', name: 'PT. Wi-Fi Anda Corp.', number: '0123-456-78910' },
            'DANA': { type: 'E-Wallet', name: 'PT. Wi-Fi Anda Corp.', number: '0812-3456-7890' },
            'OVO': { type: 'E-Wallet', name: 'PT. Wi-Fi Anda Corp.', number: '0812-3456-7890' },
            'Qris': { type: 'QRIS Payment', imageUrl: 'https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=https://example.com/payment' } // Ganti URL ini
        };

        const mainContent = document.getElementById('main-content');
        const loadingScreen = document.getElementById('loading-screen');
        const rincianTagihan = document.getElementById('rincian-tagihan');
        const paymentMethodSelect = document.getElementById('payment-method');
        const paymentDetailsContainer = document.getElementById('payment-details-container');
        const paymentProofInput = document.getElementById('payment-proof');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const uploadIcon = document.getElementById('upload-icon');
        const uploadText = document.getElementById('upload-text');
        const paymentForm = document.getElementById('payment-form');
        const debugInfo = document.getElementById('debug-info'); 

        // Fungsi khusus untuk menampilkan SweetAlert error
        const showSwalError = (title, text) => {
             Swal.fire({
                 icon: 'error',
                 title: title,
                 text: text,
                 confirmButtonText: 'OK'
             });
        };

        if (firebaseConfig) {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app); // Firestore (siap digunakan)
            rtdb = getDatabase(app); // Realtime Database (digunakan di sini)

            // Atur persistence
            setPersistence(auth, browserSessionPersistence);
            
            // --- Fungsi Penanganan Kesalahan Tampilan ---
            function displayErrorMessage(message, error = null, type = "general") {
                console.error("â›” DISPLAY ERROR:", message, error);
                
                loadingScreen.classList.add('hidden');
                mainContent.classList.remove('hidden');
                
                let displayMessage = message;
                let detailText = error ? `(Kode Error: ${error.code || 'N/A'})` : '(Gagal memuat data.)';
                let buttonHtml = `<button onclick="window.location.reload()" class="mt-4 bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition">Muat Ulang Halaman</button>`;
                let iconHtml = `<i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>`;
                let statusText = `<p class="text-xs text-gray-400 mt-2">UID Terakhir: ${userId || 'N/A'}</p>`;

                if (error && error.message.includes("permission_denied")) {
                         displayMessage = "GAGAL IZIN. Aturan keamanan Database memblokir akses.";
                         detailText = `Periksa Aturan Realtime Database Anda di path: /customers/${userId || 'UID_UNKNOWN'}`;
                } else if (type === "customerNotFound") {
                         displayMessage = "Data pelanggan tidak ditemukan untuk ID Anda.";
                         detailText = `Pastikan ada data di Realtime DB: /customers/${userId}`;
                }

                mainContent.innerHTML = `
                    <div class="text-center p-8 bg-white rounded-xl shadow-lg border border-red-200 mx-auto max-w-sm">
                        ${iconHtml}
                        <p class="text-red-700 font-semibold mb-2">${displayMessage}</p>
                        <p class="text-gray-500 text-sm mb-4">${detailText}</p>
                        ${statusText}
                        ${buttonHtml}
                    </div>`;
            }

            // --- Fungsi Pengambilan Data Pelanggan ---
            async function fetchCustomerDataAndRender(uid) {
                console.log(`[DEBUG] ðŸš€ Mencoba ambil data pelanggan untuk UID: ${uid}`);
                debugInfo.textContent = `Mengambil data di path: customers/${uid}...`;
                
                const customerRef = ref(rtdb, `customers/${uid}`);
                
                try {
                    const snapshot = await get(customerRef); 
                    
                    if (snapshot.exists()) {
                        currentCustomer = snapshot.val();
                        console.log("âœ… Data pelanggan berhasil dimuat:", currentCustomer);
                        renderPaymentDetails(currentCustomer);
                        mainContent.classList.remove('hidden');
                        loadingScreen.classList.add('hidden');
                    } else {
                        // Tidak ada data di path yang dicari
                        console.warn(`[DEBUG] âš ï¸ Data pelanggan tidak ditemukan di customers/${uid}`);
                        displayErrorMessage("Data pelanggan tidak ditemukan.", null, "customerNotFound");
                    }
                } catch (error) {
                    // Tangani error izin atau koneksi
                    console.error("âŒ ERROR FETCH DATABASE:", error);
                    displayErrorMessage("Gagal mengambil data pelanggan.", error);
                }
            }

            // --- Autentikasi dan Logika Utama ---
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // Otentikasi Berhasil
                    userId = user.uid;
                    const isAnon = user.isAnonymous ? "Anonim" : "Pengguna";
                    console.log(`[DEBUG] ðŸ”‘ Autentikasi berhasil (${isAnon}). UID: ${userId}`);
                    debugInfo.textContent = `Autentikasi berhasil. UID: ${userId}`;
                    await fetchCustomerDataAndRender(userId);
                } else {
                    // Pengguna belum terautentikasi. Redirect ke halaman login.
                    console.log("Pengguna tidak login, mengalihkan ke login.html...");
                    window.location.href = 'login.html'; // REDIRECT
                }
            });

            // --- Logika Tampilan & Form ---
            function renderPaymentDetails(customer) {
                // LOGIKA PERHITUNGAN TAGIHAN: Tagihan Pokok, PPN 10%, dan Total
                const priceInclTax = Number(customer.package_price || 0); // Harga yang terdaftar di DB (asumsi ini adalah harga jual)
                const PPN_RATE = 0.10; // 10%

                // Asumsi: Harga di DB (package_price) adalah total harga termasuk PPN 10%.
                const tagihanPokok = priceInclTax / (1 + PPN_RATE);
                const ppn = priceInclTax - tagihanPokok;
                const total = priceInclTax;
                
                // Jika package_price adalah harga bersih (sebelum PPN), gunakan logika ini:
                // const tagihanPokok = priceInclTax;
                // const ppn = tagihanPokok * PPN_RATE;
                // const total = tagihanPokok + ppn;

                const periode = new Date().toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });

                rincianTagihan.innerHTML = `
                    <div class="flex justify-between"><span class="text-gray-600">Nama Pelanggan:</span><span class="font-semibold">${customer.name || 'N/A'}</span></div>
                    <div class="flex justify-between"><span class="text-gray-600">ID Pelanggan:</span><span class="font-semibold">${customer.customer_id || 'N/A'}</span></div>
                    <div class="flex justify-between"><span class="text-gray-600">Paket:</span><span class="font-semibold">${customer.paket || 'N/A'}</span></div>
                    <div class="flex justify-between"><span class="text-gray-600">Periode:</span><span class="font-semibold">${periode}</span></div>
                    
                    <div class="flex justify-between border-t border-gray-100 pt-3 mt-3">
                        <span class="text-gray-600">Tagihan Pokok:</span><span>Rp ${Math.round(tagihanPokok).toLocaleString('id-ID')}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">PPN (10%):</span><span>Rp ${Math.round(ppn).toLocaleString('id-ID')}</span>
                    </div>
                    
                    <div class="flex justify-between text-lg font-bold pt-2 mt-2 border-t border-gray-200">
                        <span class="text-gray-800">Total Pembayaran:</span>
                        <span class="text-cyan-600">Rp ${Math.round(total).toLocaleString('id-ID')}</span>
                    </div>
                `;
            }

            // ... (Event listeners untuk form dan payment method tetap sama)

            paymentMethodSelect.addEventListener('change', (e) => {
                const method = e.target.value;
                if (method && paymentInfo[method]) {
                    const info = paymentInfo[method];
                    if (info.imageUrl) {
                        paymentDetailsContainer.innerHTML = `
                            <p class="text-sm font-semibold text-cyan-800 text-center">${info.type}</p>
                            <div class="flex justify-center mt-2">
                                <img src="${info.imageUrl}" alt="QRIS Code" class="rounded-lg shadow-md max-w-[200px]">
                            </div>
                            <p class="text-xs text-gray-600 text-center mt-2">Scan kode QR di atas menggunakan aplikasi E-Wallet Anda.</p>
                        `;
                    } else {
                        paymentDetailsContainer.innerHTML = `
                            <p class="text-sm font-semibold text-cyan-800">${info.type} - ${method}</p>
                            <p class="text-lg font-bold text-gray-800">${info.number}</p>
                            <p class="text-sm text-gray-600">a.n. <strong>${info.name}</strong></p>
                        `;
                    }
                    paymentDetailsContainer.classList.remove('hidden');
                } else {
                    paymentDetailsContainer.classList.add('hidden');
                }
            });

            paymentProofInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        imagePreview.src = event.target.result;
                        imagePreviewContainer.classList.remove('hidden');
                        uploadIcon.classList.add('hidden');
                        uploadText.textContent = file.name;
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            paymentForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const method = paymentMethodSelect.value;
                const proofFile = paymentProofInput.files[0];

                if (!method) {
                    showSwalError('Error', 'Silakan pilih metode pembayaran.');
                    return;
                }
                if (!proofFile) {
                    showSwalError('Error', 'Silakan upload bukti pembayaran.');
                    return;
                }

                Swal.fire({
                    title: 'Mengirim Konfirmasi...',
                    text: 'Mohon tunggu sebentar.',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                if (!currentCustomer) {
                    Swal.fire('Gagal', 'Data pelanggan belum termuat. Coba muat ulang halaman.', 'error');
                    return;
                }

                const priceInclTax = Number(currentCustomer.package_price || 0);
                const total = priceInclTax;

                const caption = `Konfirmasi Pembayaran Baru!\n\n` +
                                `Nama: ${currentCustomer.name}\n` +
                                `ID Pelanggan: ${currentCustomer.customer_id}\n` +
                                `Email: ${currentCustomer.email || 'N/A'}\n` +
                                `Periode: ${new Date().toLocaleDateString('id-ID', { month: 'long', year: 'numeric' })}\n` +
                                `Total: Rp ${total.toLocaleString('id-ID')}\n` +
                                `Metode: ${method}\n` +
                                `UID Pengguna: ${userId}`;

                const formData = new FormData();
                formData.append('chat_id', TELEGRAM_CHAT_ID);
                formData.append('photo', proofFile);
                formData.append('caption', caption);

                try {
                    const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendPhoto`, {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();

                    if (result.ok) {
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'Konfirmasi Terkirim!',
                            text: 'Terima kasih, pembayaran Anda akan segera kami verifikasi.',
                            timer: 3000,
                            timerProgressBar: true
                        }).then(() => {
                            paymentForm.reset();
                            imagePreviewContainer.classList.add('hidden');
                            uploadIcon.classList.remove('hidden');
                            uploadText.textContent = 'PNG, JPG hingga 10MB';
                            paymentDetailsContainer.classList.add('hidden');
                        });
                    } else {
                        throw new Error(result.description || 'Gagal mengirim ke Telegram.');
                    }
                } catch (error) {
                    console.error('Telegram API Error:', error);
                    showSwalError('Gagal', `Gagal mengirim konfirmasi: ${error.message}`);
                }
            });

        } else {
            // Tampilkan pesan kesalahan jika firebaseConfig tidak ditemukan (misal di luar Canvas)
            displayErrorMessage("Kesalahan Konfigurasi. Lingkungan Firebase tidak disiapkan.");
        }
    </script>

</body>
</html>
